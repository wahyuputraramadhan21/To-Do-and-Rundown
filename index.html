<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perencana Harian Cerdas: To-Do & Rundown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Set theme on initial load
        if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .task-item.completed > .task-main-content .task-text { text-decoration: line-through; }
        html:not(.dark) .task-item.completed > .task-main-content .task-text { color: #64748b; }
        .dark .task-item.completed > .task-main-content .task-text { color: #6b7280; }

        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f97316; }
        .priority-low { border-left: 4px solid #22c55e; }

        .modal-overlay, #menu-overlay { transition: opacity 0.3s ease; }
        .modal-content, #menu-drawer { transition: transform 0.3s ease; }
        #menu-drawer.translate-x-full { transform: translateX(100%); }

        .notes-btn.has-note svg { fill: #60a5fa; }

        .deadline-overdue { color: #ef4444; }
        .deadline-today { color: #f97316; }
        
        #rundown-for-image { font-family: 'Inter', sans-serif; }
        #rundown-for-image .rundown-item-image { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border-radius: 0.5rem; background-color: rgba(55, 65, 81, 0.5); }
        #rundown-for-image .priority-high { border-left: 4px solid #ef4444; }
        #rundown-for-image .priority-medium { border-left: 4px solid #f97316; }
        #rundown-for-image .priority-low { border-left: 4px solid #22c55e; }

        #toast-notification {
            transform: translateX(calc(100% + 1.25rem));
            transition: transform 0.4s ease-in-out;
        }
        #toast-notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-gray-900 dark:text-white antialiased">

    <div id="toast-notification" class="fixed top-5 right-5 bg-blue-500 text-white py-2 px-5 rounded-lg shadow-lg z-50">
        <p id="toast-message"></p>
    </div>

    <div id="focus-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 modal-overlay">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-11/12 max-w-md text-center transform scale-95">
            <h3 id="focus-task-title" class="text-2xl font-bold text-blue-600 dark:text-blue-300 mb-2"></h3>
            <p class="text-slate-500 dark:text-gray-400 mb-6">Waktunya untuk fokus penuh!</p>
            <div id="focus-timer" class="text-7xl font-mono font-bold tracking-widest mb-8">00:00</div>
            <div class="flex justify-center gap-4">
                <button id="pause-resume-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Jeda</button>
                <button id="close-focus-modal" class="bg-slate-500 hover:bg-slate-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Tutup</button>
            </div>
        </div>
    </div>
    <div id="notes-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 modal-overlay">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-11/12 max-w-lg text-center transform scale-95">
            <h3 id="notes-task-title" class="text-2xl font-bold text-blue-600 dark:text-blue-300 mb-4">Catatan untuk Tugas</h3>
            <textarea id="notes-textarea" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg p-3 h-40 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6" placeholder="Tulis catatan Anda di sini..."></textarea>
            <div class="flex justify-center gap-4">
                <button id="save-note-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Simpan</button>
                <button id="close-notes-modal" class="bg-slate-500 hover:bg-slate-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Tutup</button>
            </div>
        </div>
    </div>
    <div id="report-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 modal-overlay">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-11/12 max-w-md transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-600 dark:text-blue-300">Laporan Produktivitas</h3>
                <button id="close-report-modal" class="text-slate-500 dark:text-gray-400 hover:text-red-500 text-3xl">&times;</button>
            </div>
            <p class="text-slate-500 dark:text-gray-400 mb-6">Ringkasan aktivitas Anda selama 7 hari terakhir.</p>
            <div id="report-content" class="space-y-4 text-lg"></div>
        </div>
    </div>
    
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>
    <div id="menu-drawer" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-gray-800 shadow-lg z-50 transform translate-x-full">
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-6">Menu</h2>
            <nav class="flex flex-col space-y-2">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-gray-400 uppercase tracking-wider">Tampilan Cepat</h3>
                <a href="#" class="time-filter-btn p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700" data-filter="today">Tugas Hari Ini</a>
                <a href="#" class="time-filter-btn p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700" data-filter="tomorrow">Tugas Besok</a>
                <a href="#" class="time-filter-btn p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700" data-filter="week">Tugas Minggu Ini</a>
                <hr class="my-2 border-slate-200 dark:border-gray-700"/>
                <h3 class="text-sm font-semibold text-slate-500 dark:text-gray-400 uppercase tracking-wider">Lainnya</h3>
                <a href="#" id="report-btn-menu" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2zm1 12h2V2h-2v12zm-3 0V7H7v7h2zm-4 0v-3H2v3h2z"/></svg>
                    Laporan Produktivitas
                </a>
                <a href="#" id="theme-toggle-btn-menu" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="hidden" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707z"/></svg>
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="hidden" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278zM4.858 1.311A7.269 7.269 0 0 0 7.71 14.35a7.269 7.269 0 0 0 7.71-7.71 7.269 7.269 0 0 0-7.71-7.71 7.269 7.269 0 0 0-2.852.617z"/></svg>
                    Ganti Tema
                </a>
            </nav>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <div class="w-10"></div>
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Perencana Cerdas</h1>
                <p id="motivational-quote" class="mt-3 text-lg text-slate-500 dark:text-gray-400 italic">Memuat kutipan motivasi...</p>
            </div>
            <button id="menu-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>
            </button>
        </header>
        <div class="flex justify-center mb-8">
             <div class="relative w-40 h-40">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-slate-300 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="progress-circle" class="text-blue-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="stroke-dasharray: 283; stroke-dashoffset: 283; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease;" />
                </svg>
                <div id="progress-text" class="absolute inset-0 flex flex-col items-center justify-center text-2xl font-bold">
                    <span>0%</span><span class="text-sm font-normal text-slate-500 dark:text-gray-400">Selesai</span>
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex justify-between items-center border-b border-slate-200 dark:border-gray-700 pb-2 mb-4">
                    <h2 class="text-2xl font-semibold">Daftar Tugas Anda</h2>
                    <div class="text-sm">
                        <button id="show-detailed-form-btn" class="font-semibold text-blue-500 hidden">Mode Detail</button>
                        <button id="show-quick-form-btn" class="font-semibold text-blue-500">âš¡ Tambah Cepat</button>
                    </div>
                </div>

                <div id="detailed-form-container" class="hidden">
                    <form id="todo-form" class="mb-6">
                        <div class="flex items-center justify-center mb-6 gap-6">
                            <div id="indicator-1" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full border-2 border-blue-500 bg-blue-500 text-white font-bold">1</div>
                            <div id="indicator-2" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-300 dark:border-gray-600 text-slate-400 dark:text-gray-500 font-bold">2</div>
                            <div id="indicator-3" class="step-indicator flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-300 dark:border-gray-600 text-slate-400 dark:text-gray-500 font-bold">3</div>
                        </div>
                        
                        <div id="form-steps-container">
                            <div id="step-1" class="form-step space-y-4">
                                 <h3 class="font-semibold text-center text-lg">Apa tugas utamamu?</h3>
                                 <input type="text" id="task-input" placeholder="Nama tugas..." class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                 <input type="number" id="duration-input" placeholder="Estimasi durasi (menit)" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" required>
                            </div>
                            <div id="step-2" class="form-step space-y-4 hidden">
                                <h3 class="font-semibold text-center text-lg">Perlu dijadwalkan? (Opsional)</h3>
                                <input type="date" id="deadline-date-input" title="Tanggal Deadline" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="time" id="deadline-time-input" title="Waktu Deadline" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="step-3" class="form-step space-y-4 hidden">
                                 <h3 class="font-semibold text-center text-lg">Atur & Kategorikan</h3>
                                 <input type="text" id="category-input" placeholder="Kategori (mis: #Pekerjaan)" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <select id="priority-input" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="medium">Prioritas Sedang</option><option value="high">Prioritas Tinggi</option><option value="low">Prioritas Rendah</option>
                                    </select>
                                    <select id="repeat-input" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="none">Tidak Berulang</option><option value="daily">Berulang Harian</option><option value="weekly">Berulang Mingguan</option>
                                    </select>
                                 </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <button type="button" id="prev-btn" class="bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-500 font-semibold py-2 px-6 rounded-lg transition-colors hidden">Kembali</button>
                            <button type="button" id="next-btn" class="ml-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">Lanjut</button>
                            <button type="submit" id="submit-btn" class="ml-auto w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors hidden">Tambah Tugas</button>
                        </div>
                    </form>
                </div>

                <div id="quick-form-container">
                    <form id="quick-add-form" class="mb-6 space-y-3">
                        <input type="text" id="quick-task-input" placeholder="Tulis tugas cepat di sini..." class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="quick-duration-input" placeholder="Durasi (menit)" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" required>
                            <input type="date" id="quick-deadline-input" title="Tanggal" class="w-full bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition-colors duration-200">Tambah Cepat</button>
                    </form>
                </div>
                
                <div id="filter-buttons" class="flex flex-wrap gap-2 mb-4"></div>
                <div id="todo-list" class="space-y-3 overflow-y-auto pr-2" style="max-height: 40vh;"></div>
            </section>
            <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                 <h2 class="text-2xl font-semibold mb-4 border-b border-slate-200 dark:border-gray-700 pb-2">Rundown & Fokus</h2>
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
                    <div class="flex items-center gap-2">
                         <label for="start-time" class="font-medium">Mulai pukul:</label>
                         <input type="time" id="start-time" value="08:00" class="bg-slate-100 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="generate-rundown-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg transition-colors duration-200 flex-grow">Buat Rundown</button>
                    <button id="generate-image-btn" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold px-5 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Unduh Foto
                    </button>
                </div>
                <div id="rundown-output" class="space-y-3 overflow-y-auto pr-2" style="max-height: 55vh;">
                     <div class="text-center py-8 px-4 border-2 border-dashed border-slate-300 dark:border-gray-700 rounded-lg">
                        <p class="text-slate-500 dark:text-gray-400">Jadwal Anda akan muncul di sini.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <div id="rundown-for-image" class="absolute left-[-9999px] w-[450px] p-8 bg-gray-900 text-white space-y-4"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Elemen DOM ---
        const detailedFormContainer = document.getElementById('detailed-form-container');
        const todoForm = document.getElementById('todo-form');
        const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
        const indicators = [document.getElementById('indicator-1'), document.getElementById('indicator-2'), document.getElementById('indicator-3')];
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const submitBtn = document.getElementById('submit-btn');
        const taskInput = document.getElementById('task-input');
        const durationInput = document.getElementById('duration-input');
        const categoryInput = document.getElementById('category-input');
        const deadlineDateInput = document.getElementById('deadline-date-input');
        const deadlineTimeInput = document.getElementById('deadline-time-input');
        const priorityInput = document.getElementById('priority-input');
        const repeatInput = document.getElementById('repeat-input');
        const quickFormContainer = document.getElementById('quick-form-container');
        const quickAddForm = document.getElementById('quick-add-form');
        const quickTaskInput = document.getElementById('quick-task-input');
        const quickDurationInput = document.getElementById('quick-duration-input');
        const quickDeadlineInput = document.getElementById('quick-deadline-input');
        const showDetailedFormBtn = document.getElementById('show-detailed-form-btn');
        const showQuickFormBtn = document.getElementById('show-quick-form-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuOverlay = document.getElementById('menu-overlay');
        const menuDrawer = document.getElementById('menu-drawer');
        const todoListContainer = document.getElementById('todo-list');
        const rundownOutput = document.getElementById('rundown-output');
        const motivationalQuoteEl = document.getElementById('motivational-quote');
        const themeToggleBtnMenu = document.getElementById('theme-toggle-btn-menu');
        const filterButtonsContainer = document.getElementById('filter-buttons');
        const reportBtnMenu = document.getElementById('report-btn-menu');
        const reportModalOverlay = document.getElementById('report-modal-overlay');
        const closeReportModalBtn = document.getElementById('close-report-modal');
        const generateRundownBtn = document.getElementById('generate-rundown-btn');
        const startTimeInput = document.getElementById('start-time');
        const progressCircle = document.getElementById('progress-circle');
        const progressText = document.getElementById('progress-text');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const focusModalOverlay = document.getElementById('focus-modal-overlay');
        const notesModalOverlay = document.getElementById('notes-modal-overlay');
        const closeFocusModalBtn = document.getElementById('close-focus-modal');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const closeNotesModalBtn = document.getElementById('close-notes-modal');
        
        // --- State Aplikasi ---
        let currentStep = 1;
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let completionHistory = JSON.parse(localStorage.getItem('completionHistory')) || [];
        let categoryFilter = 'all';
        let timeFilter = 'all';
        let isRundownGenerated = false;
        let focusInterval, isPaused, timeRemaining, currentEditingTaskId;
        const CIRCLE_LENGTH = 283;
        const quotes = [ "Perjalanan seribu mil dimulai dengan satu langkah.", "Lakukan apa yang kamu bisa, dengan apa yang kamu miliki, di mana pun kamu berada.", "Disiplin adalah jembatan antara tujuan dan pencapaian.", "Fokus pada tujuan, bukan rintangan." ];
        
        // --- Form Switching Logic ---
        showQuickFormBtn.addEventListener('click', () => {
            detailedFormContainer.classList.add('hidden');
            quickFormContainer.classList.remove('hidden');
            showQuickFormBtn.classList.add('hidden');
            showDetailedFormBtn.classList.remove('hidden');
        });
        showDetailedFormBtn.addEventListener('click', () => {
            detailedFormContainer.classList.remove('hidden');
            quickFormContainer.classList.add('hidden');
            showQuickFormBtn.classList.remove('hidden');
            showDetailedFormBtn.classList.add('hidden');
        });

        // --- Quick Add Form Handler ---
        quickAddForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const taskText = quickTaskInput.value.trim();
            const duration = quickDurationInput.value;
            const deadlineDate = quickDeadlineInput.value;
            let deadline = null;

            if (deadlineDate) {
                deadline = new Date(`${deadlineDate}T23:59:59`).toISOString();
            }

            if (taskText && duration) {
                addTask(taskText, duration, 'medium', '', 'none', deadline);
                quickAddForm.reset();
                quickTaskInput.focus();
                showToast(`Tugas "${taskText}" ditambahkan!`);
            }
        });

        const showToast = (message) => {
            const toastMessage = document.getElementById('toast-message');
            const toast = document.getElementById('toast-notification');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        const showStep = (stepNumber) => {
            steps.forEach((step, index) => {
                step.classList.toggle('hidden', (index + 1) !== stepNumber);
            });
            indicators.forEach((indicator, index) => {
                const isCurrent = (index + 1) === stepNumber;
                const isCompleted = (index + 1) < stepNumber;
                indicator.classList.toggle('bg-blue-500', isCurrent || isCompleted);
                indicator.classList.toggle('border-blue-500', isCurrent || isCompleted);
                indicator.classList.toggle('text-white', isCurrent || isCompleted);
            });
            prevBtn.classList.toggle('hidden', stepNumber === 1);
            nextBtn.classList.toggle('hidden', stepNumber === steps.length);
            submitBtn.classList.toggle('hidden', stepNumber !== steps.length);
            currentStep = stepNumber;
        };

        nextBtn.addEventListener('click', () => {
            if (currentStep === 1 && (!taskInput.value.trim() || !durationInput.value)) {
                alert("Nama tugas dan durasi wajib diisi.");
                return;
            }
            if (currentStep < steps.length) showStep(currentStep + 1);
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 1) showStep(currentStep - 1);
        });
        
        const saveTasks = () => { localStorage.setItem('tasks', JSON.stringify(tasks)); renderAll(); };
        const saveHistory = () => { localStorage.setItem('completionHistory', JSON.stringify(completionHistory)); };
        const renderAll = () => { renderTasks(); updateProgress(); renderFilterButtons(); };
        const showMotivationalQuote = () => {
            if (motivationalQuoteEl) {
                motivationalQuoteEl.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
            }
        };
        
        const toggleMenu = (show) => {
            menuOverlay.classList.toggle('hidden', !show);
            menuDrawer.classList.toggle('translate-x-full', !show);
        };
        menuBtn.addEventListener('click', () => toggleMenu(true));
        menuOverlay.addEventListener('click', () => toggleMenu(false));

        const updateThemeUI = (isDark) => {
            document.querySelectorAll('#theme-icon-sun').forEach(el => el.classList.toggle('hidden', isDark));
            document.querySelectorAll('#theme-icon-moon').forEach(el => el.classList.toggle('hidden', !isDark));
        };
        themeToggleBtnMenu.addEventListener('click', (e) => {
            e.preventDefault();
            const isCurrentlyDark = document.documentElement.classList.contains('dark');
            if (isCurrentlyDark) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeUI(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeUI(true);
            }
        });
        
        const checkRepeatingTasks = () => {
            const today = new Date().setHours(0,0,0,0);
            tasks.forEach(task => {
                if (task.repeat === 'none' || !task.lastCompleted) return;
                const lastCompletedDate = new Date(task.lastCompleted).setHours(0,0,0,0);
                if (task.repeat === 'daily' && lastCompletedDate < today) {
                    task.completed = false;
                }
                if (task.repeat === 'weekly') {
                    const oneWeek = 7 * 24 * 60 * 60 * 1000;
                    if (today - lastCompletedDate >= oneWeek) {
                        task.completed = false;
                    }
                }
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));
        };

        const getCurrentlyVisibleTasks = () => {
            let currentTasks = [...tasks];
            if (categoryFilter !== 'all') {
                currentTasks = currentTasks.filter(t => t.category === categoryFilter);
            }
            if (timeFilter !== 'all') {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrowStart = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
                const dayAfterTomorrowStart = new Date(tomorrowStart.getTime() + 24 * 60 * 60 * 1000);
                const nextWeekEnd = new Date(todayStart.getTime() + 7 * 24 * 60 * 60 * 1000);

                currentTasks = currentTasks.filter(task => {
                    if (!task.deadline) return false;
                    const taskDeadline = new Date(task.deadline);
                    if (timeFilter === 'today') return taskDeadline >= todayStart && taskDeadline < tomorrowStart;
                    if (timeFilter === 'tomorrow') return taskDeadline >= tomorrowStart && taskDeadline < dayAfterTomorrowStart;
                    if (timeFilter === 'week') return taskDeadline >= todayStart && taskDeadline < nextWeekEnd;
                    return false;
                });
            }
            return currentTasks;
        };
        
        const renderFilterButtons = () => {
            const categories = ['all', ...new Set(tasks.map(t => t.category).filter(Boolean))];
            filterButtonsContainer.innerHTML = '';
            categories.forEach(cat => {
                const button = document.createElement('button');
                const isActive = cat === categoryFilter && timeFilter === 'all';
                button.textContent = cat === 'all' ? 'Semua Kategori' : cat;
                button.dataset.filter = cat;
                button.className = `px-3 py-1 text-sm rounded-full transition-colors ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600'}`;
                filterButtonsContainer.appendChild(button);
            });
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.toggle('bg-slate-200', btn.dataset.filter === timeFilter);
                btn.classList.toggle('dark:bg-gray-600', btn.dataset.filter === timeFilter);
            });
        };

        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                timeFilter = 'all'; 
                categoryFilter = e.target.dataset.filter;
                renderAll();
            }
        });
        
        document.querySelectorAll('.time-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                categoryFilter = 'all'; 
                timeFilter = e.target.dataset.filter;
                renderAll();
                toggleMenu(false);
                let filterName = {"today": "Hari Ini", "tomorrow": "Besok", "week": "Minggu Ini"}[timeFilter] || "";
                showToast(`Filter: Tugas ${filterName}`);
            });
        });

        const renderTasks = () => {
            todoListContainer.innerHTML = '';
            const currentTasks = getCurrentlyVisibleTasks();
            if (currentTasks.length === 0) {
                todoListContainer.innerHTML = `<p class="text-slate-500 dark:text-gray-500 text-center py-4">Tidak ada tugas yang cocok.</p>`;
                return;
            }
            const sortedTasks = [...currentTasks].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            sortedTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item bg-slate-100 dark:bg-gray-700 p-3 rounded-lg transition-all duration-200 priority-${task.priority} ${task.completed ? 'completed' : ''}`;
                taskElement.dataset.id = task.id;
                let deadlineHTML = '';
                if (task.deadline) {
                    const deadlineDate = new Date(task.deadline);
                    let deadlineClass = 'text-slate-500 dark:text-gray-400';
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    if (!task.completed && deadlineDate < now) deadlineClass = 'deadline-overdue';
                    else if (deadlineDate >= todayStart && deadlineDate < new Date(todayStart.getTime() + 24*60*60*1000)) deadlineClass = 'deadline-today';
                    
                    const formattedDate = deadlineDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                    
                    let timeString = '';
                    if (deadlineDate.getHours() !== 23 || deadlineDate.getMinutes() !== 59 || deadlineDate.getSeconds() !== 59) {
                        timeString = ' ' + deadlineDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    }

                    deadlineHTML = `<div class="flex items-center gap-1 text-xs mt-1 ${deadlineClass}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg><span>${formattedDate}${timeString}</span></div>`;
                }
                taskElement.innerHTML = `<div class="flex items-start justify-between"><div class="flex items-start gap-3 flex-grow min-w-0 task-main-content"><input type="checkbox" ${task.completed ? 'checked' : ''} class="h-5 w-5 rounded bg-slate-300 dark:bg-gray-600 border-slate-400 dark:border-gray-500 text-blue-500 focus:ring-blue-600 flex-shrink-0 mt-1"><div><span class="task-text">${task.text}</span>${task.category ? `<span class="text-xs text-blue-500 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/50 px-2 py-0.5 rounded-full ml-2">${task.category}</span>` : ''}${deadlineHTML}</div></div><div class="flex items-center flex-shrink-0 ml-2 gap-3"><span class="text-sm text-slate-500 dark:text-gray-400">${task.repeat !== 'none' ? (task.repeat === 'daily' ? '&#128260;' : '&#128197;') : ''}</span><span class="text-xs text-slate-500 dark:text-gray-400 bg-slate-200 dark:bg-gray-600 px-2 py-0.5 rounded-full">${task.duration} mnt</span><button class="notes-btn text-slate-400 dark:text-gray-400 hover:text-blue-400 transition-colors ${task.notes ? 'has-note' : ''}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 14.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h2.5a2 2 0 0 1 1.6.8L8 14.333 9.9 11.8a2 2 0 0 1 1.6-.8H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/></svg></button><button class="delete-btn text-slate-400 dark:text-gray-500 hover:text-red-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button></div></div>`;
                todoListContainer.appendChild(taskElement);
            });
        };

        const addTask = (text, duration, priority, category, repeat, deadline) => {
            const newTask = { id: Date.now(), text, duration: parseInt(duration), priority, category, repeat, deadline, completed: false, notes: '', lastCompleted: null };
            tasks.push(newTask);
            saveTasks();
        };
        const toggleTask = (id) => {
            const taskIndex = tasks.findIndex(t => t.id === id);
            if (taskIndex > -1) {
                tasks[taskIndex].completed = !tasks[taskIndex].completed;
                if (tasks[taskIndex].completed) {
                    if (tasks[taskIndex].repeat !== 'none') tasks[taskIndex].lastCompleted = new Date().toISOString();
                    completionHistory.push({ date: new Date().toISOString(), duration: tasks[taskIndex].duration });
                    saveHistory();
                }
                saveTasks();
                if (isRundownGenerated) generateRundown();
            }
        };
        const deleteTask = (id) => {
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
            if (isRundownGenerated) generateRundown();
        };
        
        const generateReport = () => {
            reportModalOverlay.classList.remove('hidden');
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const recentHistory = completionHistory.filter(item => new Date(item.date) > oneWeekAgo);
            const totalTasksCompleted = recentHistory.length;
            const totalMinutesFocused = recentHistory.reduce((sum, item) => sum + item.duration, 0);
            const reportContentEl = document.getElementById('report-content');
            reportContentEl.innerHTML = `<p><strong>Tugas Selesai:</strong> ${totalTasksCompleted} tugas</p><p><strong>Total Waktu:</strong> ${Math.floor(totalMinutesFocused / 60)} jam ${totalMinutesFocused % 60} menit</p>`;
        };
        reportBtnMenu.addEventListener('click', (e) => { e.preventDefault(); generateReport(); toggleMenu(false); });
        closeReportModalBtn.addEventListener('click', () => reportModalOverlay.classList.add('hidden'));

        const generateRundown = () => {
            const relevantTasks = getCurrentlyVisibleTasks().filter(task => !task.completed);
            if (relevantTasks.length === 0) {
                rundownOutput.innerHTML = `<div class="text-center py-8 px-4 border-2 border-dashed border-slate-300 dark:border-gray-700 rounded-lg"><p class="text-slate-500 dark:text-gray-400">Tidak ada tugas untuk dijadwalkan.</p></div>`;
                isRundownGenerated = false;
                return;
            }
            const tasksWithDeadline = relevantTasks.filter(t => t.deadline);
            let startTimeValue = tasksWithDeadline.length > 0
                ? new Date(Math.min(...tasksWithDeadline.map(t => new Date(t.deadline).getTime()))).toTimeString().slice(0, 5)
                : startTimeInput.value;
            startTimeInput.value = startTimeValue;
            if (!startTimeValue) {
                rundownOutput.innerHTML = '<p class="text-red-400 text-center">Waktu mulai tidak valid.</p>';
                isRundownGenerated = false;
                return;
            }
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            const tasksToSchedule = [...relevantTasks].sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            rundownOutput.innerHTML = '';
            const [startHour, startMinute] = startTimeValue.split(':').map(Number);
            let currentTime = new Date();
            currentTime.setHours(startHour, startMinute, 0, 0);
            isRundownGenerated = true;
            tasksToSchedule.forEach((task) => {
                const startTime = new Date(currentTime);
                const endTime = new Date(currentTime.getTime() + task.duration * 60000);
                const formatTime = (date) => date.toTimeString().slice(0, 5);
                const rundownItem = document.createElement('div');
                rundownItem.className = `flex items-center gap-4 bg-slate-100 dark:bg-gray-700/50 p-3 rounded-lg priority-${task.priority}`;
                rundownItem.innerHTML = `<div class="text-right font-mono text-sm"><p class="text-blue-500 dark:text-blue-300">${formatTime(startTime)}</p><p class="text-slate-500 dark:text-gray-400">${formatTime(endTime)}</p></div><div class="border-l-2 border-slate-300 dark:border-gray-600 pl-4 flex-grow"><p class="font-semibold">${task.text}</p><p class="text-xs text-slate-500 dark:text-gray-400">${task.duration} menit</p></div><div class="flex flex-col sm:flex-row gap-2"><button data-task-id="${task.id}" class="complete-btn-rundown bg-green-600/50 hover:bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full transition-colors">Selesai</button><button data-task-id="${task.id}" data-duration="${task.duration}" class="focus-btn bg-blue-600/50 hover:bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full transition-colors">Fokus</button></div>`;
                rundownOutput.appendChild(rundownItem);
                currentTime = endTime;
            });
        };

        todoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const deadline = deadlineDateInput.value ? new Date(`${deadlineDateInput.value}T${deadlineTimeInput.value || '00:00'}`).toISOString() : null;
            if (taskInput.value.trim() && durationInput.value) {
                addTask(taskInput.value.trim(), durationInput.value, priorityInput.value, categoryInput.value.trim(), repeatInput.value, deadline);
                todoForm.reset(); 
                taskInput.focus();
                showToast(`Tugas ditambahkan dengan detail!`);
            }
        });
        
        const updateProgress = () => {
            const totalTasks = tasks.length;
            if (totalTasks === 0) {
                progressText.querySelector('span').textContent = '0%';
                progressCircle.style.strokeDashoffset = CIRCLE_LENGTH;
                return;
            }
            const completedTasks = tasks.filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);
            progressText.querySelector('span').textContent = `${percentage}%`;
            progressCircle.style.strokeDashoffset = CIRCLE_LENGTH - (percentage / 100) * CIRCLE_LENGTH;
            if (percentage === 100 && completedTasks > 0) confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        };
        const generateRundownImage = () => {
            if (!isRundownGenerated) return alert("Silakan buat rundown terlebih dahulu.");
            const originalButtonText = generateImageBtn.innerHTML;
            generateImageBtn.disabled = true;
            generateImageBtn.innerHTML = `Memproses...`;
            const imageContainer = document.getElementById('rundown-for-image');
            const date = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let imageHTML = `<h2 class="text-3xl font-bold text-center text-blue-300 mb-2">Rundown Hari Ini</h2><p class="text-center text-gray-400 mb-6">${date}</p>`;
            rundownOutput.querySelectorAll('.flex.items-center.gap-4').forEach(item => {
                const timeEl = item.querySelector('.text-right').cloneNode(true);
                const taskEl = item.querySelector('.border-l-2').cloneNode(true);
                const priorityClass = item.className.match(/priority-\w+/)[0];
                imageHTML += `<div class="rundown-item-image ${priorityClass}"><div style="font-family: 'Inter', monospace; text-align: right; font-size: 0.875rem;"><p style="color: #93c5fd;">${timeEl.children[0].textContent}</p><p style="color: #9ca3af;">${timeEl.children[1].textContent}</p></div><div style="border-left: 2px solid #4b5563; padding-left: 1rem; flex-grow: 1;"><p style="font-weight: 600;">${taskEl.children[0].textContent}</p><p style="font-size: 0.75rem; color: #9ca3af;">${taskEl.children[1].textContent}</p></div></div>`;
            });
            imageContainer.innerHTML = imageHTML;
            html2canvas(imageContainer, { scale: 2, useCORS: true, backgroundColor: '#111827' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `rundown-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => console.error("Gagal membuat gambar:", err)).finally(() => {
                generateImageBtn.disabled = false;
                generateImageBtn.innerHTML = originalButtonText;
            });
        };
        const startFocusTimer = (durationMinutes, taskTitle) => {
            clearInterval(focusInterval);
            timeRemaining = durationMinutes * 60;
            isPaused = false;
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const focusTaskTitle = document.getElementById('focus-task-title');
            const focusTimerEl = document.getElementById('focus-timer');
            pauseResumeBtn.textContent = 'Jeda';
            focusTaskTitle.textContent = taskTitle;
            focusInterval = setInterval(() => {
                if (isPaused) return;
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                focusTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    clearInterval(focusInterval);
                    focusTimerEl.textContent = "SELESAI!";
                    new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
                }
            }, 1000);
            focusModalOverlay.classList.remove('hidden');
        };
        const openNotesModal = (taskId) => {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentEditingTaskId = taskId;
            document.getElementById('notes-task-title').textContent = `Catatan untuk: ${task.text}`;
            document.getElementById('notes-textarea').value = task.notes || '';
            notesModalOverlay.classList.remove('hidden');
        };
        const closeNotesModal = () => {
            notesModalOverlay.classList.add('hidden');
            currentEditingTaskId = null;
        };
        const saveNote = () => {
            if (currentEditingTaskId === null) return;
            const task = tasks.find(t => t.id === currentEditingTaskId);
            if (task) {
                task.notes = document.getElementById('notes-textarea').value.trim();
                saveTasks();
            }
            closeNotesModal();
        };

        todoListContainer.addEventListener('click', (e) => { const taskElement = e.target.closest('.task-item'); if (!taskElement) return; const taskId = Number(taskElement.dataset.id); if (e.target.closest('input[type="checkbox"]')) { toggleTask(taskId); } if (e.target.closest('.delete-btn')) { deleteTask(taskId); } if (e.target.closest('.notes-btn')) { openNotesModal(taskId); } });
        generateRundownBtn.addEventListener('click', generateRundown);
        generateImageBtn.addEventListener('click', generateRundownImage);
        rundownOutput.addEventListener('click', (e) => { const focusBtn = e.target.closest('.focus-btn'); if (focusBtn) { const taskId = Number(focusBtn.dataset.taskId); const duration = Number(focusBtn.dataset.duration); const task = tasks.find(t => t.id === taskId); if (task) startFocusTimer(duration, task.text); } const completeBtn = e.target.closest('.complete-btn-rundown'); if(completeBtn) { const taskId = Number(completeBtn.dataset.taskId); toggleTask(taskId); } });
        
        closeFocusModalBtn.addEventListener('click', () => { clearInterval(focusInterval); focusModalOverlay.classList.add('hidden'); });
        saveNoteBtn.addEventListener('click', saveNote);
        closeNotesModalBtn.addEventListener('click', closeNotesModal);
        
        showMotivationalQuote();
        checkRepeatingTasks();
        updateThemeUI(document.documentElement.classList.contains('dark'));
        // Default to quick form on load
        showDetailedFormBtn.click(); 
        showQuickFormBtn.click();
        renderAll();
    });
    </script>
</body>
</html>

